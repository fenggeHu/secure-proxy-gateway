<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Secure Proxy Gateway</title>
    <link rel="stylesheet" href="/static/codemirror/lib/codemirror.min.css" />
    <script src="/static/codemirror/lib/codemirror.min.js"></script>
    <script src="/static/codemirror/mode/yaml/yaml.min.js"></script>
    <script src="/static/codemirror/mode/javascript/javascript.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f6f8fa;
        margin: 0;
        padding: 0;
      }
      header {
        background: #0f172a;
        color: #fff;
        padding: 14px 20px;
      }
      main {
        padding: 20px;
      }
      .card {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      }
      .tabs {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }
      .tab {
        background: #e2e8f0;
        color: #0f172a;
        border: 1px solid #cbd5e1;
        padding: 8px 12px;
        border-radius: 999px;
        cursor: pointer;
      }
      .tab.active {
        background: #2563eb;
        border-color: #2563eb;
        color: #fff;
      }
      .meta {
        font-size: 0.9rem;
        color: #475569;
      }
      input,
      textarea,
      select {
        width: 100%;
        font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
        border-radius: 6px;
        border: 1px solid #d1d5db;
        padding: 8px;
        box-sizing: border-box;
      }
      textarea {
        min-height: 120px;
      }
      button {
        background: #2563eb;
        color: #fff;
        border: none;
        padding: 10px 16px;
        border-radius: 6px;
        cursor: pointer;
      }
      button.secondary {
        background: #e2e8f0;
        color: #0f172a;
        border: 1px solid #cbd5e1;
      }
      button.danger {
        background: #dc2626;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .row-3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 12px;
      }
      .toolbar {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      .error {
        color: #b91c1c;
        margin-top: 8px;
        white-space: pre-wrap;
      }
      .success {
        color: #16a34a;
        margin-top: 8px;
        white-space: pre-wrap;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        border-bottom: 1px solid #e5e7eb;
        padding: 10px 8px;
        text-align: left;
        vertical-align: top;
      }
      th {
        color: #334155;
        font-size: 0.9rem;
      }
      .small {
        font-size: 0.9rem;
        color: #475569;
      }
      .CodeMirror {
        height: 520px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
      }
      details {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 8px 10px;
        background: #f8fafc;
      }
      details > summary {
        cursor: pointer;
        color: #0f172a;
        font-weight: 600;
      }
      .kv {
        display: grid;
        grid-template-columns: 1fr 1fr auto;
        gap: 8px;
        align-items: center;
        margin-top: 8px;
      }
    </style>
  </head>
  <body>
    <header>
      <h2>Secure Proxy Gateway</h2>
    </header>
    <main>
      <div class="tabs">
        <button id="tab-routes" class="tab active" type="button">Routes</button>
        <button id="tab-raw" class="tab" type="button">Raw</button>
        <span class="meta"
          >Path: <span id="config-path">-</span> Â· Format:
          <span id="config-format">-</span></span
        >
      </div>

      <div id="msg-error" class="error" style="display: none"></div>
      <div id="msg-success" class="success" style="display: none"></div>

      <section id="view-routes" class="card">
        <div class="toolbar">
          <input id="route-filter" placeholder="Search routes (name/path/target)" />
          <button id="btn-add-route" type="button">Add Route</button>
          <button id="btn-reload" class="secondary" type="button">Reload</button>
          <label class="small" style="display: flex; gap: 6px; align-items: center">
            <input id="compact-save" type="checkbox" checked style="width: auto" />
            Compact save
          </label>
          <button id="btn-save-all" type="button">Save All</button>
          <button id="btn-validate" class="secondary" type="button">Validate</button>
        </div>

        <div style="margin-top: 12px; overflow: auto">
          <table>
            <thead>
              <tr>
                <th style="min-width: 160px">Name</th>
                <th style="min-width: 90px">Method</th>
                <th style="min-width: 180px">Path</th>
                <th>Target</th>
                <th style="min-width: 190px">Actions</th>
              </tr>
            </thead>
            <tbody id="route-table"></tbody>
          </table>
        </div>

        <div class="card" style="margin-top: 16px">
          <h3 style="margin-top: 0">Route Editor</h3>
          <div class="row-3">
            <div>
              <div class="small">Name</div>
              <input id="f-name" placeholder="unique-route-name" />
            </div>
            <div>
              <div class="small">Method</div>
              <select id="f-method">
                <option value="*">*</option>
                <option value="GET">GET</option>
                <option value="POST">POST</option>
                <option value="PUT">PUT</option>
                <option value="PATCH">PATCH</option>
                <option value="DELETE">DELETE</option>
                <option value="OPTIONS">OPTIONS</option>
                <option value="HEAD">HEAD</option>
              </select>
            </div>
            <div>
              <div class="small">Path</div>
              <input id="f-path" placeholder="/api/demo" />
            </div>
          </div>
          <div class="row" style="margin-top: 10px">
            <div>
              <div class="small">Target</div>
              <input id="f-target" placeholder="https://example.com" />
            </div>
            <div>
              <div class="small">Description</div>
              <input id="f-desc" placeholder="optional" />
            </div>
          </div>

          <details style="margin-top: 12px">
            <summary>Request Rules (optional)</summary>
            <div class="row" style="margin-top: 10px">
              <div>
                <div class="small">add_headers (JSON object)</div>
                <textarea id="f-add-headers" placeholder='{"X-Proxy-Source":"secure-gateway"}'></textarea>
              </div>
              <div>
                <div class="small">add_params (JSON object)</div>
                <textarea id="f-add-params" placeholder='{"_from":"proxy"}'></textarea>
              </div>
            </div>
            <div style="margin-top: 10px">
              <div class="small">del_params (comma-separated)</div>
              <input id="f-del-params" placeholder="debug, foo" />
            </div>
          </details>

          <details style="margin-top: 12px">
            <summary>Response Masking (optional)</summary>
            <div class="small" style="margin-top: 8px">
              mask_regex: list of {pattern, replacement}
            </div>
            <div id="mask-list"></div>
            <div class="toolbar">
              <button id="btn-add-mask" class="secondary" type="button">Add Mask Rule</button>
            </div>
          </details>

          <div class="toolbar" style="margin-top: 12px">
            <button id="btn-apply-route" type="button">Apply</button>
            <button id="btn-delete-route" class="danger" type="button">Delete</button>
            <button id="btn-clear-editor" class="secondary" type="button">Clear</button>
          </div>
          <div class="small" style="margin-top: 8px">
            Tip: advanced/edge cases can still be edited in the Raw tab.
          </div>
        </div>
      </section>

      <section id="view-raw" class="card" style="display: none">
        <div class="toolbar">
          <label style="min-width: 180px">
            Format
            <select id="raw-format">
              <option value="yaml">yaml</option>
              <option value="json">json</option>
            </select>
          </label>
          <button id="raw-reload" class="secondary" type="button">Reload</button>
          <button id="raw-validate" class="secondary" type="button">Validate</button>
          <button id="raw-save" type="button">Save</button>
        </div>
        <textarea id="raw-editor" spellcheck="false"></textarea>
      </section>
    </main>

    <script>
      const el = (id) => document.getElementById(id);
      const msgError = el("msg-error");
      const msgSuccess = el("msg-success");
      const configPathEl = el("config-path");
      const configFormatEl = el("config-format");

      const tabRoutes = el("tab-routes");
      const tabRaw = el("tab-raw");
      const viewRoutes = el("view-routes");
      const viewRaw = el("view-raw");

      const routeFilter = el("route-filter");
      const routeTable = el("route-table");
      const compactSave = el("compact-save");

      const fName = el("f-name");
      const fMethod = el("f-method");
      const fPath = el("f-path");
      const fTarget = el("f-target");
      const fDesc = el("f-desc");
      const fAddHeaders = el("f-add-headers");
      const fAddParams = el("f-add-params");
      const fDelParams = el("f-del-params");
      const maskList = el("mask-list");

      const rawFormat = el("raw-format");
      const rawTextarea = el("raw-editor");
      const btnSaveAll = el("btn-save-all");

      let current = { config: { routes: [] }, raw: "", format: "yaml", path: "" };
      let selectedIndex = null;
      let rawCm = null;
      let draftRoute = { request_rules: {}, response_rules: { mask_regex: [] } };
      let dirty = false;

      function setDirty(value) {
        dirty = !!value;
        btnSaveAll.textContent = dirty ? "Save All (unsaved)" : "Save All";
        btnSaveAll.style.background = dirty ? "#f59e0b" : "#2563eb";
      }

      function setActiveTab(tab) {
        if (tab === "routes") {
          tabRoutes.classList.add("active");
          tabRaw.classList.remove("active");
          viewRoutes.style.display = "block";
          viewRaw.style.display = "none";
        } else {
          tabRoutes.classList.remove("active");
          tabRaw.classList.add("active");
          viewRoutes.style.display = "none";
          viewRaw.style.display = "block";
          initRawEditor();
          if (rawCm) rawCm.refresh();
        }
      }

      function showError(message) {
        msgError.textContent = message || "";
        msgError.style.display = message ? "block" : "none";
      }

      function showSuccess(message) {
        msgSuccess.textContent = message || "";
        msgSuccess.style.display = message ? "block" : "none";
      }

      function normalizeJsonObject(text) {
        const trimmed = (text || "").trim();
        if (!trimmed) return {};
        const obj = JSON.parse(trimmed);
        if (obj === null || Array.isArray(obj) || typeof obj !== "object") {
          throw new Error("Expected JSON object");
        }
        return obj;
      }

      function parseDelParams(text) {
        return (text || "")
          .split(",")
          .map((s) => s.trim())
          .filter(Boolean);
      }

      function clearEditor() {
        selectedIndex = null;
        draftRoute = { request_rules: {}, response_rules: { mask_regex: [] } };
        fName.value = "";
        fMethod.value = "*";
        fPath.value = "";
        fTarget.value = "";
        fDesc.value = "";
        fAddHeaders.value = "";
        fAddParams.value = "";
        fDelParams.value = "";
        renderMaskRules(draftRoute.response_rules.mask_regex);
        renderRoutes();
      }

      function renderMaskRules(rules) {
        maskList.innerHTML = "";
        (rules || []).forEach((rule, idx) => {
          const row = document.createElement("div");
          row.className = "kv";
          const p = document.createElement("input");
          p.placeholder = "pattern (regex)";
          p.value = rule.pattern || "";
          const repl = document.createElement("input");
          repl.placeholder = "replacement";
          repl.value = rule.replacement || "";
          const del = document.createElement("button");
          del.type = "button";
          del.className = "danger";
          del.textContent = "Remove";
          del.addEventListener("click", () => {
            const route = getSelectedRoute();
            route.response_rules = route.response_rules || {};
            route.response_rules.mask_regex = (route.response_rules.mask_regex || []).filter((_, i) => i !== idx);
            renderMaskRules(route.response_rules.mask_regex);
          });
          row.appendChild(p);
          row.appendChild(repl);
          row.appendChild(del);
          maskList.appendChild(row);
          p.addEventListener("input", () => (rule.pattern = p.value));
          repl.addEventListener("input", () => (rule.replacement = repl.value));
        });
      }

      function getSelectedRoute() {
        if (selectedIndex === null) {
          return draftRoute;
        }
        return current.config.routes[selectedIndex];
      }

      function selectRoute(idx) {
        selectedIndex = idx;
        const r = current.config.routes[idx];
        fName.value = r.name || "";
        fMethod.value = (r.method || "*").toUpperCase();
        fPath.value = r.path || "";
        fTarget.value = r.target || "";
        fDesc.value = r.description || "";

        const rr = r.request_rules || {};
        const addHeaders = rr.add_headers || {};
        const addParams = rr.add_params || {};
        const delParams = rr.del_params || [];
        fAddHeaders.value = Object.keys(addHeaders).length ? JSON.stringify(addHeaders, null, 2) : "";
        fAddParams.value = Object.keys(addParams).length ? JSON.stringify(addParams, null, 2) : "";
        fDelParams.value = delParams.join(", ");

        const resp = r.response_rules || {};
        renderMaskRules(resp.mask_regex || []);
        renderRoutes();
      }

      function renderRoutes() {
        const filter = (routeFilter.value || "").toLowerCase();
        const rows = (current.config.routes || []).filter((r) => {
          const hay = `${r.name || ""} ${r.path || ""} ${r.target || ""}`.toLowerCase();
          return !filter || hay.includes(filter);
        });

        routeTable.innerHTML = "";
        rows.forEach((r) => {
          const idx = current.config.routes.indexOf(r);
          const tr = document.createElement("tr");
          if (idx === selectedIndex) tr.style.background = "#eff6ff";

          const tdName = document.createElement("td");
          tdName.textContent = r.name || "";
          const tdMethod = document.createElement("td");
          tdMethod.textContent = (r.method || "*").toUpperCase();
          const tdPath = document.createElement("td");
          tdPath.textContent = r.path || "";
          const tdTarget = document.createElement("td");
          tdTarget.textContent = r.target || "";
          const tdAct = document.createElement("td");

          const btnEdit = document.createElement("button");
          btnEdit.type = "button";
          btnEdit.className = "secondary";
          btnEdit.textContent = "Edit";
          btnEdit.addEventListener("click", () => selectRoute(idx));

          const btnCopy = document.createElement("button");
          btnCopy.type = "button";
          btnCopy.className = "secondary";
          btnCopy.textContent = "Copy YAML";
          btnCopy.addEventListener("click", async () => {
            const snippet = [
              "- name: " + (r.name || ""),
              "  path: " + (r.path || ""),
              "  target: " + (r.target || ""),
              "  method: " + ((r.method || "*").toUpperCase()),
            ].join("\\n");
            try {
              await navigator.clipboard.writeText(snippet + "\\n");
              showSuccess("Copied route snippet to clipboard");
            } catch (e) {
              showError("Clipboard not available: " + String(e));
            }
          });

          const btnDel = document.createElement("button");
          btnDel.type = "button";
          btnDel.className = "danger";
          btnDel.textContent = "Delete";
          btnDel.addEventListener("click", () => {
            current.config.routes.splice(idx, 1);
            setDirty(true);
            if (selectedIndex === idx) clearEditor();
            else if (selectedIndex !== null && idx < selectedIndex) selectedIndex -= 1;
            renderRoutes();
          });

          tdAct.appendChild(btnEdit);
          tdAct.appendChild(document.createTextNode(" "));
          tdAct.appendChild(btnCopy);
          tdAct.appendChild(document.createTextNode(" "));
          tdAct.appendChild(btnDel);

          tr.appendChild(tdName);
          tr.appendChild(tdMethod);
          tr.appendChild(tdPath);
          tr.appendChild(tdTarget);
          tr.appendChild(tdAct);
          routeTable.appendChild(tr);
        });
      }

      function collectRouteFromForm() {
        const name = (fName.value || "").trim();
        const method = (fMethod.value || "*").toUpperCase();
        const path = (fPath.value || "").trim();
        const target = (fTarget.value || "").trim();
        const desc = (fDesc.value || "").trim();

        if (!name) throw new Error("Route name is required");
        if (!path || !path.startsWith("/")) throw new Error("Route path must start with '/'");
        if (!target) throw new Error("Route target is required");

        const addHeaders = normalizeJsonObject(fAddHeaders.value);
        const addParams = normalizeJsonObject(fAddParams.value);
        const delParams = parseDelParams(fDelParams.value);

        const route = {
          name,
          method,
          path,
          target,
          description: desc || null,
          request_rules: {
            add_headers: addHeaders,
            add_params: addParams,
            del_params: delParams,
          },
          response_rules: {
            mask_regex: [],
          },
        };

        const existing = getSelectedRoute();
        const existingMasks =
          (existing.response_rules && existing.response_rules.mask_regex) || [];
        route.response_rules.mask_regex = existingMasks.map((x) => ({
          pattern: x.pattern || "",
          replacement: x.replacement || "",
        }));
        return route;
      }

      async function fetchConfig() {
        const resp = await fetch("/api/config");
        if (!resp.ok) throw new Error(await resp.text());
        const data = await resp.json();
        current = data;
        current.config = current.config || { routes: [] };
        current.config.routes = current.config.routes || [];
        configPathEl.textContent = data.path || "-";
        configFormatEl.textContent = data.format || "-";
        rawFormat.value = data.format || "yaml";
        if (rawCm) {
          rawCm.setValue(data.raw || "");
          setRawMode(rawFormat.value);
        } else {
          rawTextarea.value = data.raw || "";
        }
        renderRoutes();
        if (selectedIndex !== null) selectRoute(selectedIndex);
        setDirty(false);
      }

      async function saveAll() {
        showError("");
        showSuccess("");
        const headers = { "Content-Type": "application/json" };
        if (compactSave.checked) headers["X-Config-Minimal"] = "1";
        const resp = await fetch("/api/config", {
          method: "POST",
          headers,
          body: JSON.stringify(current.config),
        });
        if (!resp.ok) throw new Error(await resp.text());
        showSuccess("Saved config");
        await fetchConfig();
      }

      async function validateAll() {
        showError("");
        showSuccess("");
        const resp = await fetch("/api/config/validate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(current.config),
        });
        if (!resp.ok) throw new Error(await resp.text());
        showSuccess("Config is valid");
      }

      function initRawEditor() {
        if (!window.CodeMirror) return;
        if (rawCm) return;
        rawCm = CodeMirror.fromTextArea(rawTextarea, {
          lineNumbers: true,
          lineWrapping: true,
          viewportMargin: Infinity,
        });
        setRawMode(rawFormat.value);
      }

      function setRawMode(fmt) {
        if (!rawCm) return;
        if (fmt === "json") rawCm.setOption("mode", { name: "javascript", json: true });
        else rawCm.setOption("mode", "yaml");
      }

      async function rawSave() {
        showError("");
        showSuccess("");
        initRawEditor();
        const payload = {
          content: rawCm ? rawCm.getValue() : rawTextarea.value,
          format: rawFormat.value,
        };
        const resp = await fetch("/api/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error(await resp.text());
        showSuccess("Saved raw config");
        await fetchConfig();
      }

      async function rawValidate() {
        showError("");
        showSuccess("");
        initRawEditor();
        const payload = {
          content: rawCm ? rawCm.getValue() : rawTextarea.value,
          format: rawFormat.value,
        };
        const resp = await fetch("/api/config/validate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error(await resp.text());
        showSuccess("Raw config is valid");
      }

      tabRoutes.addEventListener("click", () => setActiveTab("routes"));
      tabRaw.addEventListener("click", () => setActiveTab("raw"));

      routeFilter.addEventListener("input", () => renderRoutes());
      el("btn-add-route").addEventListener("click", () => {
        clearEditor();
        showSuccess("Fill the form and click Apply");
      });
      el("btn-reload").addEventListener("click", () => fetchConfig().catch((e) => showError(String(e))));
      el("btn-save-all").addEventListener("click", () => saveAll().catch((e) => showError(String(e))));
      el("btn-validate").addEventListener("click", () => validateAll().catch((e) => showError(String(e))));

      el("btn-add-mask").addEventListener("click", () => {
        const route = getSelectedRoute();
        route.response_rules = route.response_rules || {};
        route.response_rules.mask_regex = route.response_rules.mask_regex || [];
        route.response_rules.mask_regex.push({ pattern: "", replacement: "" });
        renderMaskRules(route.response_rules.mask_regex);
        setDirty(true);
      });

      el("btn-apply-route").addEventListener("click", () => {
        try {
          showError("");
          showSuccess("");
          const route = collectRouteFromForm();
          const nameExists = current.config.routes.some((r, idx) => r.name === route.name && idx !== selectedIndex);
          if (nameExists) throw new Error(`Route name '${route.name}' already exists`);

          if (selectedIndex === null) {
            current.config.routes.push(route);
            selectedIndex = current.config.routes.length - 1;
          } else {
            current.config.routes[selectedIndex] = route;
          }
          setDirty(true);
          showSuccess("Applied locally (click Save All to persist)");
          renderRoutes();
          selectRoute(selectedIndex);
        } catch (e) {
          showError(String(e));
        }
      });

      el("btn-delete-route").addEventListener("click", () => {
        if (selectedIndex === null) return;
        current.config.routes.splice(selectedIndex, 1);
        clearEditor();
        setDirty(true);
        showSuccess("Deleted locally (click Save All to persist)");
      });

      el("btn-clear-editor").addEventListener("click", () => clearEditor());

      rawFormat.addEventListener("change", () => {
        setRawMode(rawFormat.value);
      });
      el("raw-reload").addEventListener("click", () => fetchConfig().catch((e) => showError(String(e))));
      el("raw-save").addEventListener("click", () => rawSave().catch((e) => showError(String(e))));
      el("raw-validate").addEventListener("click", () => rawValidate().catch((e) => showError(String(e))));

      fetchConfig().catch((e) => showError(String(e)));
      clearEditor();
      setDirty(false);
    </script>
  </body>
</html>
